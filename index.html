<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>csvビューア</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jQuery + DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 30px;
      font-size: 14px;
      line-height: 1.5;
    }

    form {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    table.dataTable thead th {
      background-color: #f4f4f4;
      border-bottom: 2px solid #ccc;
      padding: 8px 12px;
      text-align: left;
    }

    #dataTable tbody td {
      border-bottom: 1px solid #eee;
      padding: 8px 12px;
    }

    #dataTable tbody tr:nth-child(even) {
      background-color: #fafafa;
    }

    #dataTable tbody tr:hover {
      background-color: #f0f8ff;
    }

    .chart-container {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      margin-top: 40px;
    }

    canvas {
      aspect-ratio: 1 / 1;
      max-width: 400px;
      width: 100%;
      height: auto;
    }
  </style>
</head>

<body>
  <h2>csvビューア</h2>
  <p>ジャンルと月を選んでCSVを表示できます。</p>

  <form onsubmit="event.preventDefault(); loadCSV();">
    <label>ジャンル:
      <select id="genre">
        <option value="セット">セット</option>
        <option value="タン">タン</option>
        <option value="その他">その他</option>
      </select>
    </label>

    <label>月:
      <select id="month">
        <option value="202505">2025年5月</option>
      </select>
    </label>

    <button type="submit">表示</button>
  </form>

  <div id="tableArea"></div>

  <div class="chart-container">
    <canvas id="barChart"></canvas>
    <canvas id="pieChart"></canvas>
  </div>

  <script>
    function loadCSV() {
      const genre = document.getElementById("genre").value;
      const month = document.getElementById("month").value;
      const filename = `data/${genre}_${month}.csv`;

      fetch(filename)
        .then(response => {
          if (!response.ok) throw new Error("CSV file not found");
          return response.text();
        })
        .then(text => {
          const rows = text.trim().split("\n").map(row => row.split(","));
          displayTable(rows);
          drawCharts(rows);
        })
        .catch(err => {
          document.getElementById("tableArea").innerHTML = `<p style='color:red;'>${err.message}</p>`;
        });
    }

    function displayTable(rows) {
      let html = `<table id="dataTable"><thead><tr>`;
      rows[0].forEach(col => html += `<th>${col}</th>`);
      html += "</tr></thead><tbody>";
      for (let i = 1; i < rows.length; i++) {
        html += "<tr>";
        rows[i].forEach(col => html += `<td>${col}</td>`);
        html += "</tr>";
      }
      html += "</tbody></table>";
      document.getElementById("tableArea").innerHTML = html;

      // 表示後にDataTableを初期化
      $('#dataTable').DataTable();
    }

    function drawCharts(rows) {
      const labels = [];
      const sales = [];
      const shares = [];

      for (let i = 1; i < rows.length; i++) {
        labels.push(rows[i][0]); // ジャンル名
        sales.push(Number(rows[i][1].replace(/,/g, ""))); // 売上指標
        shares.push(parseFloat(rows[i][2].replace("%", ""))); // シェア
      }

      // 棒グラフ
      const barCtx = document.getElementById("barChart").getContext("2d");
      if (window.barChart instanceof Chart) window.barChart.destroy();
      window.barChart = new Chart(barCtx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "売上指標（千円）",
            data: sales,
            backgroundColor: "rgba(75, 192, 192, 0.6)"
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: "ジャンル別 売上指標"
            },
            legend: {
              position: "top"
            }
          },
          layout: {
            padding: {
              top: 10,
              bottom: 10
            }
          }
        }
      });

      // 円グラフ
      const pieCtx = document.getElementById("pieChart").getContext("2d");
      if (window.pieChart instanceof Chart) window.pieChart.destroy();
      window.pieChart = new Chart(pieCtx, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{
            label: "シェア（%）",
            data: shares,
            backgroundColor: [
              "#ff6384", "#36a2eb", "#ffcd56", "#4bc0c0", "#9966ff", "#ff9f40"
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1,
          layout: {
            padding: {
              top: 10,
              bottom: 10
            }
          },
          plugins: {
            title: {
              display: true,
              text: "ジャンル別 シェア率"
            },
            legend: {
              position: "bottom"
            }
          }
        }
      });
    }
  </script>
</body>
</html>
