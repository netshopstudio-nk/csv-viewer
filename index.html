<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <title>ジャンル別CSVビューア（月間合計）</title>
  <script src="./chart.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet"/>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    h2 { margin-bottom: 10px; }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    select, button {
      font-size: 14px;
      padding: 4px 8px;
    }
    canvas { max-width: 100%; }
  </style>
</head>
<body>
  <h2>ジャンル別CSVビューア（月間合計）</h2>
  <div class="controls">
    <div class="control-row">
      <label>ジャンル:</label>
      <div id="genre-selects"></div>
    </div>
    <div class="control-row">
      <label>年月:</label>
      <select id="monthSelect"></select>
      <button onclick="loadMonthlyTotal()">表示</button>
    </div>
  </div>
  <table id="resultTable" class="display" style="width:100%">
    <thead><tr><th>ジャンル</th><th>売上指数（千円）</th></tr></thead>
    <tbody></tbody>
  </table>
  <canvas id="barChart" height="200"></canvas>
  <canvas id="pieChart" height="200"></canvas>

  <script>
    let genreTree = {};
    let csvData = [];

    async function fetchGenreTree() {
      const response = await fetch('genre_tree_merged.json');
      genreTree = await response.json();
      renderSelectUI();
    }

    function renderSelectUI() {
      const container = document.getElementById("genre-selects");
      container.innerHTML = "";

      let tree = genreTree;
      let selectedPath = [];

      function createSelect(levelTree, depth) {
        const select = document.createElement("select");
        const emptyOption = document.createElement("option");
        emptyOption.text = "---";
        emptyOption.value = "";
        select.appendChild(emptyOption);

        for (let key in levelTree) {
          const option = document.createElement("option");
          option.text = key;
          option.value = key;
          select.appendChild(option);
        }

        select.onchange = () => {
          selectedPath = selectedPath.slice(0, depth);
          if (select.value) {
            selectedPath.push(select.value);
            renderSelectUI();
          }
        };

        container.appendChild(select);
        select.selectedIndex = 0;

        const key = selectedPath[depth];
        if (key && levelTree[key]) {
          select.value = key;
          const hasChildren = levelTree[key] && typeof levelTree[key] === 'object' && Object.keys(levelTree[key]).length > 0;
          if (hasChildren) {
            createSelect(levelTree[key], depth + 1);
          }
        }
      }

      createSelect(tree, 0);
    }

    async function loadMonthlyTotal() {
      const selectedMonth = document.getElementById("monthSelect").value;
      const selects = document.querySelectorAll("#genre-selects select");
      const selectedPath = Array.from(selects).map(s => s.value).filter(Boolean);
      if (!selectedMonth || selectedPath.length === 0) {
        alert("ジャンルと年月を選択してください");
        return;
      }

      const filename = `data/${selectedMonth}.csv`;
      const response = await fetch(filename);
      const text = await response.text();
      const lines = text.trim().split("\n").slice(1);
      const rows = lines.map(line => {
        const [genre, sales] = line.split(",");
        return { genre: genre.trim(), sales: parseFloat(sales) };
      });

      // 最下層判定
      const depth = selectedPath.length;
      const subtree = selectedPath.reduce((t, k) => t?.[k], genreTree);
      const isLeaf = subtree && Object.keys(subtree).length === 0;
      const actualDepth = isLeaf ? depth : depth + 1;

      const filtered = {};
      for (const row of rows) {
        const parts = row.genre.split(">").map(p => p.trim());
        if (parts.length < actualDepth) continue;
        const bucketKey = parts.slice(0, actualDepth).join(">");
        if (!filtered[bucketKey]) {
          filtered[bucketKey] = 0;
        }
        filtered[bucketKey] += row.sales;
      }

      const data = Object.entries(filtered).map(([genre, sales]) => ({ genre, sales }));

      // 表更新
      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.genre}</td><td>${row.sales.toLocaleString()}</td>`;
        tbody.appendChild(tr);
      });

      if (window.barChart) window.barChart.destroy();
      if (window.pieChart) window.pieChart.destroy();

      const labels = data.map(d => d.genre);
      const values = data.map(d => d.sales);

      const barCtx = document.getElementById("barChart").getContext("2d");
      window.barChart = new Chart(barCtx, {
        type: 'bar',
        data: { labels, datasets: [{ label: '売上指数（千円）', data: values }] }
      });

      const pieCtx = document.getElementById("pieChart").getContext("2d");
      window.pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: { labels, datasets: [{ data: values }] }
      });
    }

    async function init() {
      await fetchGenreTree();
      const select = document.getElementById("monthSelect");
      for (let y = 2022; y <= 2025; y++) {
        for (let m = 1; m <= 12; m++) {
          const mm = m.toString().padStart(2, "0");
          const option = document.createElement("option");
          option.value = `food_${y}${mm}`;
          option.text = `食品 ${y}年${m}月`;
          select.appendChild(option);
          const option2 = document.createElement("option");
          option2.value = `health_${y}${mm}`;
          option2.text = `ダイエット・健康 ${y}年${m}月`;
          select.appendChild(option2);
        }
      }
    }

    init();
  </script>
</body>
</html>
