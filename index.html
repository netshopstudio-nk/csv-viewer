<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ジャンル別 月間合計ビューア</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" />
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    canvas {
      max-width: 100%;
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <h1>ジャンル別 月間合計ビューア</h1>
  <div>
    <label>ジャンル階層:</label>
    <select id="genre1"></select>
    <select id="genre2"></select>
    <select id="genre3"></select>
    <select id="genre4"></select>
  </div>
  <div>
    <label>開始月:</label>
    <input type="month" id="startMonth" />
    <label>終了月:</label>
    <input type="month" id="endMonth" />
    <button id="loadData">表示</button>
  </div>

  <table id="dataTable" class="display">
    <thead>
      <tr><th>ジャンル名</th><th>売上指数（千円）</th><th>シェア</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <canvas id="barChart"></canvas>
  <canvas id="pieChart"></canvas>

  <script>
    const files = {
      "202405": "food_202405.csv",
      "202406": "food_202406.csv",
      "202409": "food_202409.csv",
      "202306": "health_202306.csv"
    };

    function formatMonth(month) {
      return month.replace("-", "");
    }

    function getGenrePath() {
      const levels = ["#genre1", "#genre2", "#genre3", "#genre4"];
      return levels.map(sel => $(sel).val()).filter(v => v).join(">");
    }

    let barChart, pieChart;

    function drawCharts(labels, values) {
      const backgroundColors = ["#4e79a7", "#f28e2b", "#e15759", "#76b7b2", "#59a14f", "#edc948", "#b07aa1", "#ff9da7", "#9c755f", "#bab0ab"];

      if (barChart) barChart.destroy();
      if (pieChart) pieChart.destroy();

      barChart = new Chart(document.getElementById("barChart"), {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{ label: "売上指数（千円）", data: values, backgroundColor: backgroundColors }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });

      pieChart = new Chart(document.getElementById("pieChart"), {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{ data: values, backgroundColor: backgroundColors }]
        },
        options: { responsive: true }
      });
    }

    async function loadAndDisplay() {
      const start = formatMonth($("#startMonth").val());
      const end = formatMonth($("#endMonth").val());
      const genre = getGenrePath();
      const tableData = {};

      for (const ym in files) {
        if (ym >= start && ym <= end) {
          const response = await fetch(`data/${files[ym]}`);
          const text = await response.text();
          const rows = text.trim().split("\n").slice(1);

          for (const row of rows) {
            const [name, salesStr] = row.split(",");
            if (name.startsWith(genre)) {
              if (!tableData[name]) tableData[name] = 0;
              tableData[name] += parseFloat(salesStr);
            }
          }
        }
      }

      const labels = Object.keys(tableData);
      const values = Object.values(tableData);
      const total = values.reduce((a, b) => a + b, 0);

      const tbody = $("#dataTable tbody").empty();
      labels.forEach((label, i) => {
        const share = total ? (values[i] / total * 100).toFixed(2) : "0.00";
        tbody.append(`<tr><td>${label}</td><td>${values[i].toLocaleString()}</td><td>${share}%</td></tr>`);
      });

      if ($.fn.DataTable.isDataTable("#dataTable")) {
        $('#dataTable').DataTable().clear().destroy();
      }
      $('#dataTable').DataTable();

      drawCharts(labels, values);
    }

    $("#loadData").on("click", loadAndDisplay);
  </script>
</body>
</html>
