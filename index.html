<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <title>ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥CSVãƒ“ãƒ¥ãƒ¼ã‚¢ï¼ˆæœˆé–“åˆè¨ˆï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet"/>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    h2 { margin-bottom: 10px; }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    select, button {
      font-size: 1rem;
      padding: 5px 10px;
    }
    #dataTable {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    #dataTable thead { background-color: #f0f0f0; }
    #dataTable tbody tr:nth-child(even) { background-color: #fafafa; }
    #dataTable tbody tr:hover { background-color: #f1f8ff; }
    #chartContainer {
      margin-top: 40px;
    }
    canvas {
      max-width: 100%;
      margin: 20px 0;
    }
  </style>
</head>
<body>
<h2>ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥ æœˆé–“åˆè¨ˆãƒ“ãƒ¥ãƒ¼ã‚¢</h2>
<p>ã‚¸ãƒ£ãƒ³ãƒ«éšå±¤ã‚’é¸æŠã—ã€æŒ‡å®šã—ãŸæœŸé–“ã®å£²ä¸Šåˆè¨ˆã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
<div class="controls">
  <div class="control-row" id="genreSelects"></div>
  <div class="control-row">
    <label>é–‹å§‹æœˆ:
      <select id="startMonth"></select>
    </label>
    <label>çµ‚äº†æœˆ:
      <select id="endMonth"></select>
    </label>
    <button onclick="loadMonthlyTotal()">è¡¨ç¤º</button>
  </div>
</div>

<table id="dataTable">
  <thead>
    <tr><th>ã‚¸ãƒ£ãƒ³ãƒ«å</th><th>å£²ä¸ŠæŒ‡æ•°ï¼ˆåƒå††ï¼‰</th></tr>
  </thead>
  <tbody></tbody>
</table>

<div id="chartContainer">
  <canvas id="barChart"></canvas>
  <canvas id="pieChart"></canvas>
</div>

<script>
let genreTree = {};
let selectedPath = [];

fetch('genre_tree_merged.json')
  .then(res => res.json())
  .then(data => {
    genreTree = data;
    renderSelectUI(genreTree, document.getElementById("genreSelects"));
  });

function renderSelectUI(tree, container, path = []) {
  if (container.children.length > path.length) {
    container.innerHTML = '';
    renderSelectUI(genreTree, container);
    return;
  }
  const select = document.createElement("select");
  select.innerHTML = `<option value="">é¸æŠã—ã¦ãã ã•ã„</option>`;
  for (const key in tree) {
    const hasChildren = Object.keys(tree[key]).length > 0;
    const option = document.createElement("option");
    option.value = key;
    option.textContent = hasChildren ? `${key} â–¸` : key;
    select.appendChild(option);
  }
  select.onchange = () => {
    while (container.children.length > path.length + 1) {
      container.removeChild(container.lastChild);
    }
    const selected = select.value.replace(/ â–¸$/, '');
    selectedPath = [...path, selected];
    if (selected && tree[selected]) {
      renderSelectUI(tree[selected], container, selectedPath);
    }
  };
  container.appendChild(select);
}

async function loadMonthlyTotal() {
  const startMonth = document.getElementById("startMonth").value;
  const endMonth = document.getElementById("endMonth").value;
  if (!startMonth || !endMonth || startMonth > endMonth) {
    alert("æ­£ã—ã„æœˆã®ç¯„å›²ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  const genrePrefix = selectedPath.join(">");
  const topGenre = selectedPath[0] || "";
  const genreType = topGenre.includes("ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ") ? "health" : "food";

  const months = [];
  const [sy, sm] = startMonth.split("-").map(Number);
  const [ey, em] = endMonth.split("-").map(Number);
  for (let y = sy; y <= ey; y++) {
    for (let m = 1; m <= 12; m++) {
      if ((y === sy && m < sm) || (y === ey && m > em)) continue;
      months.push(y + ("0" + m).slice(-2));
    }
  }

  const summary = {};
  for (const month of months) {
    const filename = `data/${genreType}_${month}.csv`;
    try {
      const res = await fetch(filename);
      if (!res.ok) continue;
      const text = await res.text();
      const rows = text.trim().split("\n").slice(1);
      for (const row of rows) {
        const [name, salesStr] = row.split(",");
        if (!name.startsWith(genrePrefix)) continue;
        const key = name.trim();
        const sales = parseFloat(salesStr || 0);
        if (!summary[key]) summary[key] = { sales: 0 };
        summary[key].sales += sales;
      }
    } catch (e) {
      console.error("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", filename);
    }
  }

  const table = document.getElementById("dataTable");
  const tbody = table.querySelector("tbody");
  tbody.innerHTML = "";
  const labels = [], values = [];
  for (const [key, data] of Object.entries(summary)) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${key}</td><td>${data.sales.toFixed(0)}</td>`;
    tbody.appendChild(tr);
    labels.push(key.split(">").pop());
    values.push(data.sales);
  }

  console.log("ğŸŸ¢ ã‚°ãƒ©ãƒ•æç”»ãƒ‡ãƒ¼ã‚¿", labels, values);

  if ($.fn.dataTable.isDataTable("#dataTable")) $('#dataTable').DataTable().destroy();
  $('#dataTable').DataTable();

  if (window.barChart) window.barChart.destroy();
  if (window.pieChart) window.pieChart.destroy();
  const colors = labels.map((_, i) => `hsl(${i * 30 % 360}, 60%, 60%)`);

  const ctxBar = document.getElementById("barChart").getContext("2d");
  const ctxPie = document.getElementById("pieChart").getContext("2d");

  window.barChart = new Chart(ctxBar, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'å£²ä¸ŠæŒ‡æ•°ï¼ˆåƒå††ï¼‰', data: values, backgroundColor: colors }] },
    options: {
      indexAxis: 'y',
      plugins: {
        title: { display: true, text: "ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥ å£²ä¸Šï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰" },
        tooltip: {
          callbacks: {
            label: ctx => `${labels[ctx.dataIndex]}: ${values[ctx.dataIndex].toLocaleString()} åƒå††`
          }
        }
      }
    }
  });

  window.pieChart = new Chart(ctxPie, {
    type: 'pie',
    data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
    options: {
      plugins: {
        title: { display: true, text: "ã‚¸ãƒ£ãƒ³ãƒ«æ§‹æˆæ¯”ï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰" },
        tooltip: {
          callbacks: {
            label: ctx => `${labels[ctx.dataIndex]}: ${values[ctx.dataIndex].toLocaleString()} åƒå††`
          }
        }
      }
    }
  });
}

document.addEventListener("DOMContentLoaded", () => {
  const start = document.getElementById("startMonth");
  const end = document.getElementById("endMonth");
  for (let y = 2022; y <= 2025; y++) {
    for (let m = 1; m <= 12; m++) {
      const ym = `${y}-${("0" + m).slice(-2)}`;
      if (ym >= "2022-05" && ym <= "2025-12") {
        start.innerHTML += `<option value="${ym}">${ym}</option>`;
        end.innerHTML += `<option value="${ym}">${ym}</option>`;
      }
    }
  }
  start.value = "2025-04";
  end.value = "2025-05";
});
</script>
</body>
</html>
