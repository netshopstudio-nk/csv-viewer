<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>csvビューア</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: "Segoe UI", sans-serif; margin: 20px; }

  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 20px;
    font-size: 15px;
  }

  th {
    background-color: #f4f4f4;
    border-bottom: 2px solid #ccc;
    padding: 10px;
    text-align: left;
  }

  td {
    border-bottom: 1px solid #eee;
    padding: 10px;
  }

  tr:nth-child(even) {
    background-color: #fafafa;
  }

  tr:hover {
    background-color: #f0f8ff;
  }

  .chart-container {
    display: flex;
    flex-wrap: wrap;
    gap: 30px;
    margin-top: 40px;
  }

  canvas {
    max-width: 500px;
    height: 300px;
  }
</style>
</head>
<body>
  <h2>csvビューア</h2>
  <p>ジャンルと月を選んでCSVを表示できます。</p>

  <label>ジャンル:
    <select id="genre">
      <option value="セット">セット</option>
      <option value="タン">タン</option>
      <option value="その他">その他</option>
    </select>
  </label>

  <label>月:
    <select id="month">
      <option value="202505">2025年5月</option>
    </select>
  </label>

  <button onclick="loadCSV()">表示</button>

  <div id="tableArea"></div>

  <div class="chart-container">
    <canvas id="barChart"></canvas>
    <canvas id="pieChart"></canvas>
  </div>

  <script>
    function loadCSV() {
      const genre = document.getElementById("genre").value;
      const month = document.getElementById("month").value;
      const filename = `data/${genre}_${month}.csv`;

      fetch(filename)
        .then(response => {
          if (!response.ok) throw new Error("CSV file not found");
          return response.text();
        })
        .then(text => {
          const rows = text.trim().split("\n").map(row => row.split(","));
          displayTable(rows);
          drawCharts(rows);
        })
        .catch(err => {
          document.getElementById("tableArea").innerHTML = `<p style='color:red;'>${err.message}</p>`;
        });
    }

    function displayTable(rows) {
      let html = "<table><tr>";
      rows[0].forEach(col => html += `<th>${col}</th>`);
      html += "</tr>";
      for (let i = 1; i < rows.length; i++) {
        html += "<tr>";
        rows[i].forEach(col => html += `<td>${col}</td>`);
        html += "</tr>";
      }
      html += "</table>";
      document.getElementById("tableArea").innerHTML = html;
    }

    function drawCharts(rows) {
      const labels = [];
      const sales = [];
      const shares = [];

      for (let i = 1; i < rows.length; i++) {
        labels.push(rows[i][0]); // ジャンル名
        sales.push(Number(rows[i][1].replace(/,/g, ""))); // 売上指標
        shares.push(parseFloat(rows[i][2].replace("%", ""))); // シェア
      }

      // 棒グラフ
      const barCtx = document.getElementById("barChart").getContext("2d");
      if (window.barChart instanceof Chart) window.barChart.destroy();
      window.barChart = new Chart(barCtx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "売上指標（千円）",
            data: sales,
            backgroundColor: "rgba(75, 192, 192, 0.6)"
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: "ジャンル別 売上指標"
            }
          }
        }
      });

      // 円グラフ
      const pieCtx = document.getElementById("pieChart").getContext("2d");
      if (window.pieChart instanceof Chart) window.pieChart.destroy();
      window.pieChart = new Chart(pieCtx, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{
            label: "シェア（%）",
            data: shares,
            backgroundColor: [
              "#ff6384", "#36a2eb", "#ffcd56", "#4bc0c0", "#9966ff", "#ff9f40"
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: "ジャンル別 シェア率"
            }
          }
        }
      });
    }
  </script>
</body>
</html>
