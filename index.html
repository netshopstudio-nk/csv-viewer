<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ジャンル別CSVビューア（月間合計）</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet" />
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    h2 { margin-bottom: 10px; }
    .controls { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .control-row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    select, button { font-size: 1rem; padding: 5px 10px; }
    #dataTable { border-collapse: collapse; width: 100%; margin-top: 20px; }
    #dataTable thead { background-color: #f0f0f0; }
    #dataTable tbody tr:nth-child(even) { background-color: #fafafa; }
    #dataTable tbody tr:hover { background-color: #f1f8ff; }
    canvas { max-width: 100%; margin: 20px 0; }
  </style>
</head>
<body>
<h2>ジャンル別 月間合計ビューア</h2>
<p>ジャンル階層を選択し、指定した期間の売上合計を表示します。</p>

<div class="controls">
  <div class="control-row" id="genreSelects"></div>
  <div class="control-row">
    <label>開始月: <select id="startMonth"></select></label>
    <label>終了月: <select id="endMonth"></select></label>
    <button onclick="loadMonthlyTotal()">表示</button>
  </div>
</div>

<table id="dataTable"></table>

<div id="chartContainer">
  <canvas id="barChart"></canvas>
  <canvas id="pieChart"></canvas>
</div>

<script>
let genreTree = {};
let selectedPath = [];

fetch('genre_tree_merged.json')
  .then(res => res.json())
  .then(data => {
    genreTree = data;
    renderSelectUI(genreTree, document.getElementById("genreSelects"));
  });

function renderSelectUI(tree, container, path = []) {
  if (container.children.length > path.length) {
    container.innerHTML = '';
    renderSelectUI(genreTree, container);
    return;
  }
  const select = document.createElement("select");
  select.innerHTML = `<option value="">選択してください</option>`;
  for (const key in tree) {
    const hasChildren = Object.keys(tree[key]).length > 0;
    const option = document.createElement("option");
    option.value = key;
    option.textContent = hasChildren ? `${key} ▸` : key;
    select.appendChild(option);
  }
  select.onchange = () => {
    while (container.children.length > path.length + 1) {
      container.removeChild(container.lastChild);
    }
    const selected = select.value.replace(/ ▸$/, '');
    selectedPath = [...path, selected];
    if (selected && tree[selected]) {
      renderSelectUI(tree[selected], container, selectedPath);
    }
  };
  container.appendChild(select);
}

function getLeafPaths(tree, prefix = '') {
  let paths = [];
  for (const key in tree) {
    const fullPath = prefix ? prefix + '>' + key : key;
    if (Object.keys(tree[key]).length === 0) {
      paths.push(fullPath);
    } else {
      paths = paths.concat(getLeafPaths(tree[key], fullPath));
    }
  }
  return paths;
}

function getPrefixName(path) {
  if (path.includes('健康')) return 'health';
  if (path.includes('食品')) return 'food';
  return 'data'; // fallback
}

function getSelectedSubtree(tree, path) {
  let node = tree;
  for (const key of path) {
    if (!node[key]) return null;
    node = node[key];
  }
  return node;
}

async function loadMonthlyTotal() {
  const startMonth = document.getElementById("startMonth").value;
  const endMonth = document.getElementById("endMonth").value;
  if (!startMonth || !endMonth || startMonth > endMonth || selectedPath.length === 0) {
    alert("ジャンルと月を正しく選択してください");
    return;
  }

  const months = [];
  const [sy, sm] = startMonth.split("-").map(Number);
  const [ey, em] = endMonth.split("-").map(Number);
  for (let y = sy; y <= ey; y++) {
    for (let m = 1; m <= 12; m++) {
      if ((y === sy && m < sm) || (y === ey && m > em)) continue;
      months.push(y + ("0" + m).slice(-2));
    }
  }

  const selectedSubtree = getSelectedSubtree(genreTree, selectedPath);
  if (!selectedSubtree) return alert("選択したジャンルが存在しません");

  const leafPaths = getLeafPaths(selectedSubtree, selectedPath.join('>'));
  const summary = {};

  for (const path of leafPaths) {
    const prefix = getPrefixName(path);
    for (const month of months) {
      const rawFilename = `data/${prefix}_${month}.csv`;
      try {
        const res = await fetch(rawFilename);
        if (!res.ok) continue;
        const text = await res.text();
        const rows = text.trim().split('\n').slice(1);
        for (const row of rows) {
          const [genre, salesStr] = row.split(',');
          const fullKey = path + ">" + genre;
          const sales = parseFloat(salesStr || 0);
          if (!summary[fullKey]) summary[fullKey] = 0;
          summary[fullKey] += sales;
        }
      } catch (e) {
        console.warn("ファイル読み込みエラー:", rawFilename);
      }
    }
  }

  const table = document.getElementById("dataTable");
  table.innerHTML = "<thead><tr><th>ジャンル名</th><th>売上指数（千円）</th></tr></thead><tbody>";
  const labels = [], values = [];

  for (const [key, value] of Object.entries(summary)) {
    const label = key.split('>').pop();
    labels.push(label);
    values.push(value);
    table.innerHTML += `<tr><td>${key}</td><td>${value.toLocaleString()}</td></tr>`;
  }
  table.innerHTML += "</tbody>";
  if ($.fn.dataTable.isDataTable("#dataTable")) {
    $('#dataTable').DataTable().destroy();
  }
  $('#dataTable').DataTable();

  if (window.barChart) window.barChart.destroy();
  if (window.pieChart) window.pieChart.destroy();

  const colors = labels.map((_, i) => `hsl(${i * 30 % 360}, 60%, 60%)`);

  const ctxBar = document.getElementById("barChart").getContext("2d");
  window.barChart = new Chart(ctxBar, {
    type: 'bar',
    data: {
      labels,
      datasets: [{ label: '売上指数（千円）', data: values, backgroundColor: colors }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: {
        title: { display: true, text: "ジャンル別 売上（棒グラフ）" }
      }
    }
  });

  const ctxPie = document.getElementById("pieChart").getContext("2d");
  window.pieChart = new Chart(ctxPie, {
    type: 'pie',
    data: {
      labels,
      datasets: [{ data: values, backgroundColor: colors }]
    },
    options: {
      plugins: {
        title: { display: true, text: "ジャンル構成比（円グラフ）" }
      }
    }
  });
}

document.addEventListener("DOMContentLoaded", () => {
  const start = document.getElementById("startMonth");
  const end = document.getElementById("endMonth");
  for (let y = 2022; y <= 2025; y++) {
    for (let m = 1; m <= 12; m++) {
      const ym = `${y}-${("0" + m).slice(-2)}`;
      if (ym >= "2022-05" && ym <= "2025-12") {
        start.innerHTML += `<option value="${ym}">${ym}</option>`;
        end.innerHTML += `<option value="${ym}">${ym}</option>`;
      }
    }
  }
  start.value = "2025-04";
  end.value = "2025-05";
});
</script>
</body>
</html>
