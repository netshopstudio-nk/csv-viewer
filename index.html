<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <title>ジャンル別CSVビューア（月範囲集計）</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet"/>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    h2 { margin-bottom: 10px; }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    select, button {
      font-size: 1rem;
      padding: 5px 10px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    thead { background-color: #f0f0f0; }
    tbody tr:nth-child(even) { background-color: #fafafa; }
    tbody tr:hover { background-color: #f1f8ff; }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
  </style>
</head>
<body>
  <h2>ジャンル別CSVビューア（月範囲集計）</h2>
  <p>ジャンルごとの売上指数などを、指定月の範囲で合計して表示します。</p>

  <div class="controls">
    <div class="control-row">
      <label>開始月:
        <select id="startMonth"></select>
      </label>
      <label>終了月:
        <select id="endMonth"></select>
      </label>
      <button onclick="loadMonthlyTotal()">表示</button>
    </div>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th>ジャンル名</th>
        <th>売上指数（千円）合計</th>
        <th>シェア合計</th>
        <th>商品ランク入り数合計</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function loadMonthlyTotal() {
      const startMonth = document.getElementById("startMonth").value;
      const endMonth = document.getElementById("endMonth").value;
      if (!startMonth || !endMonth || startMonth > endMonth) {
        alert("正しい月の範囲を選択してください");
        return;
      }

      const genreTree = await fetch("genre_tree.json").then(res => res.json());
      const flatGenres = [];
      function flatten(tree, parent = "") {
        for (const [key, value] of Object.entries(tree)) {
          const fullPath = parent ? parent + ">" + key : key;
          if (typeof value === "object" && value !== null) {
            flatten(value, fullPath);
          }
        }
      }
      flatten(genreTree);

      const months = [];
      const [sy, sm] = startMonth.split("-").map(Number);
      const [ey, em] = endMonth.split("-").map(Number);
      for (let y = sy; y <= ey; y++) {
        for (let m = 1; m <= 12; m++) {
          if ((y === sy && m < sm) || (y === ey && m > em)) continue;
          months.push(y + ("0" + m).slice(-2));
        }
      }

      const summary = {};
      for (const month of months) {
        for (const genre of flatGenres) {
          const filename = `data/${genre}_${month}.csv`;
          try {
            const response = await fetch(filename);
            if (!response.ok) continue;
            const text = await response.text();
            const rows = text.trim().split("\n").slice(1);
            for (const row of rows) {
              const [subGenre, salesStr, shareStr, rankStr] = row.split(",");
              const key = genre + ">" + subGenre;
              const sales = parseFloat(salesStr || 0);
              const share = parseFloat(shareStr || 0);
              const rank = parseInt(rankStr || 0);
              if (!summary[key]) {
                summary[key] = { sales: 0, share: 0, rank: 0 };
              }
              summary[key].sales += sales;
              summary[key].share += share;
              summary[key].rank += rank;
            }
          } catch (e) {
            continue;
          }
        }
      }

      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      for (const [key, data] of Object.entries(summary)) {
        const row = `<tr>
          <td>${key}</td>
          <td>${Math.round(data.sales).toLocaleString()}</td>
          <td>${data.share.toFixed(2)}%</td>
          <td>${data.rank}</td>
        </tr>`;
        tbody.innerHTML += row;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const start = document.getElementById("startMonth");
      const end = document.getElementById("endMonth");
      const options = [];
      for (let y = 2022; y <= 2025; y++) {
        for (let m = 1; m <= 12; m++) {
          const ym = y + "-" + ("0" + m).slice(-2);
          if (ym >= "2022-05" && ym <= "2025-05") {
            options.push(ym);
          }
        }
      }
      for (const opt of options) {
        start.innerHTML += `<option value="${opt}">${opt}</option>`;
        end.innerHTML += `<option value="${opt}">${opt}</option>`;
      }
      start.value = "2025-04";
      end.value = "2025-05";
    });
  </script>
</body>
</html>
