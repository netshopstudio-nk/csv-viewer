<!-- 以下、必要な部分だけ差し替えればOKです -->
<!-- CSVファイル: genre_sales.csv に保存している想定 -->
<body>
  <h2>ジャンル売上ビューア</h2>
  <p>全ジャンルの売上をCSVファイルから表示します。</p>

  <button onclick="loadFlatCSV()">表示</button>

  <div id="tableArea"></div>

  <div class="chart-container">
    <div class="chart-box-bar">
      <canvas id="barChart"></canvas>
    </div>
    <div class="chart-box-pie">
      <canvas id="pieChart"></canvas>
    </div>
  </div>

<script>
function loadFlatCSV() {
  fetch("genre_sales.csv")
    .then(res => {
      if (!res.ok) throw new Error("CSVファイルが見つかりません");
      return res.text();
    })
    .then(text => {
      const rows = text.trim().split("\n").map(row => row.split(","));
      displayTable(rows);
      drawCharts(rows);
    })
    .catch(err => {
      document.getElementById("tableArea").innerHTML = `<p style="color:red;">${err.message}</p>`;
    });
}

function displayTable(rows) {
  let html = `<table id="dataTable"><thead><tr>`;
  rows[0].forEach(col => html += `<th>${col}</th>`);
  html += "</tr></thead><tbody>";
  for (let i = 1; i < rows.length; i++) {
    html += "<tr>";
    rows[i].forEach(col => html += `<td>${col}</td>`);
    html += "</tr>";
  }
  html += "</tbody></table>";
  document.getElementById("tableArea").innerHTML = html;
  $('#dataTable').DataTable();
}

function drawCharts(rows) {
  const labels = [];
  const sales = [];

  for (let i = 1; i < rows.length; i++) {
    labels.push(rows[i][0]);
    const val = Number(rows[i][1].replace(/,/g, ""));
    sales.push(val);
  }

  const pieData = sales.slice();
  const barCtx = document.getElementById("barChart").getContext("2d");
  if (window.barChart instanceof Chart) window.barChart.destroy();
  window.barChart = new Chart(barCtx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "実売上（円）",
        data: sales,
        backgroundColor: "rgba(75, 192, 192, 0.6)"
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: "ジャンル別 売上（棒グラフ）"
        }
      }
    }
  });

  const pieCtx = document.getElementById("pieChart").getContext("2d");
  if (window.pieChart instanceof Chart) window.pieChart.destroy();
  window.pieChart = new Chart(pieCtx, {
    type: "pie",
    data: {
      labels: labels,
      datasets: [{
        label: "売上シェア",
        data: pieData,
        backgroundColor: [
          "#ff6384", "#36a2eb", "#ffcd56", "#4bc0c0", "#9966ff", "#ff9f40", "#c9cbcf"
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: "ジャンル別 売上シェア（円）"
        },
        legend: {
          position: "bottom"
        }
      }
    }
  });
}
</script>
</body>
