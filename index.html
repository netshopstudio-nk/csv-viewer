<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <title>ジャンル別CSVビューア（月間合計）</title>
  <script src="./chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet"/>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    h2 { margin-bottom: 10px; }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    select, button {
      font-size: 1rem;
      padding: 5px 10px;
    }
    #chartContainer {
      margin-top: 40px;
    }
    canvas {
      max-width: 100%;
      margin: 20px 0;
    }
  </style>
</head>
<body>
<h2>ジャンル別 月間合計ビューア</h2>
<p>ジャンル階層を選択し、指定した期間の売上合計を表示します。</p>
<div class="controls">
  <div class="control-row" id="genreSelects"></div>
  <div class="control-row">
    <label>開始月:
      <select id="startMonth"></select>
    </label>
    <label>終了月:
      <select id="endMonth"></select>
    </label>
    <button onclick="loadMonthlyTotal()">表示</button>
    <button onclick="downloadPDF()">PDF出力</button>
  </div>
</div>

<table id="dataTable" class="display" style="width:100%">
  <thead>
    <tr><th>ジャンル名</th><th>売上指数（千円）</th><th>シェア</th></tr>
  </thead>
  <tbody></tbody>
</table>

<div id="chartContainer">
  <canvas id="barChart" width="800" height="400"></canvas>
  <canvas id="pieChart" width="800" height="400"></canvas>
</div>

<script>
let genreTree = {};
let selectedPath = [];
let latestLabels = [];
let latestValues = [];

fetch('genre_tree_merged.json')
  .then(res => res.json())
  .then(data => {
    genreTree = data;
    renderSelectUI(genreTree, document.getElementById("genreSelects"));
  });

function renderSelectUI(tree, container, path = []) {
  if (container.children.length > path.length) {
    container.innerHTML = '';
    renderSelectUI(genreTree, container);
    return;
  }
  const select = document.createElement("select");
  select.innerHTML = `<option value="">選択してください</option>`;
  for (const key in tree) {
    const hasChildren = Object.keys(tree[key]).length > 0;
    const option = document.createElement("option");
    option.value = key;
    option.textContent = hasChildren ? `${key} ▸` : key;
    select.appendChild(option);
  }
  select.onchange = () => {
    while (container.children.length > path.length + 1) {
      container.removeChild(container.lastChild);
    }
    const selected = select.value.replace(/ ▸$/, '');
    selectedPath = [...path, selected];
    if (selected && tree[selected]) {
      renderSelectUI(tree[selected], container, selectedPath);
    }
  };
  container.appendChild(select);
}

async function loadMonthlyTotal() {
  const startMonth = document.getElementById("startMonth").value;
  const endMonth = document.getElementById("endMonth").value;
  if (!startMonth || !endMonth || startMonth > endMonth) {
    alert("正しい月の範囲を選択してください");
    return;
  }

  const genrePrefix = selectedPath.join(">");
  const topGenre = selectedPath[0] || "";
  const genreType = topGenre.includes("ダイエット") ? "health" : "food";

  const months = [];
  const [sy, sm] = startMonth.split("-").map(Number);
  const [ey, em] = endMonth.split("-").map(Number);
  for (let y = sy; y <= ey; y++) {
    for (let m = 1; m <= 12; m++) {
      if ((y === sy && m < sm) || (y === ey && m > em)) continue;
      months.push(y + ("0" + m).slice(-2));
    }
  }

  const summary = {};
  for (const month of months) {
    const filename = `data/${genreType}_${month}.csv`;
    try {
      const res = await fetch(filename);
      if (!res.ok) continue;
      const text = await res.text();
      const rows = text.trim().split("\n").slice(1);
      for (const row of rows) {
        const [name, salesStr] = row.split(",");
        if (!name.startsWith(genrePrefix)) continue;
        const key = name.trim();
        const sales = parseFloat(salesStr || 0);
        if (!summary[key]) summary[key] = 0;
        summary[key] += sales;
      }
    } catch (e) {
      console.error("読み込みエラー:", filename);
    }
  }

  latestLabels = [], latestValues = [];
  for (const [key, val] of Object.entries(summary)) {
    latestLabels.push(key.split(">").pop());
    latestValues.push(val);
  }

  const totalSales = latestValues.reduce((sum, val) => sum + val, 0);
  const tableData = latestLabels.map((label, i) => [
    genrePrefix + ">" + label,
    latestValues[i].toLocaleString(),
    totalSales ? ((latestValues[i] / totalSales) * 100).toFixed(2) + "%" : "0.00%"
  ]);

  if ($.fn.dataTable.isDataTable("#dataTable")) {
    $('#dataTable').DataTable().clear().rows.add(tableData).draw();
  } else {
    $('#dataTable').DataTable({
      data: tableData,
      columns: [
        { title: "ジャンル名" },
        { title: "売上指数（千円）" },
        { title: "シェア" }
      ]
    });
  }

  if (window.barChart) window.barChart.destroy();
  if (window.pieChart) window.pieChart.destroy();

  const colors = latestLabels.map((_, i) => `hsl(${i * 30 % 360}, 60%, 60%)`);

  const ctxBar = document.getElementById("barChart").getContext("2d");
  window.barChart = new Chart(ctxBar, {
    type: 'bar',
    data: {
      labels: latestLabels,
      datasets: [{
        label: '売上指数（千円）',
        data: latestValues,
        backgroundColor: colors
      }]
    },
    options: {
      indexAxis: 'y',
      plugins: {
        title: { display: true, text: "ジャンル別 売上（棒グラフ）" }
      }
    }
  });

  const ctxPie = document.getElementById("pieChart").getContext("2d");
  window.pieChart = new Chart(ctxPie, {
    type: 'pie',
    data: {
      labels: latestLabels,
      datasets: [{
        data: latestValues,
        backgroundColor: colors
      }]
    },
    options: {
      plugins: {
        title: { display: true, text: "ジャンル構成比（円グラフ）" }
      }
    }
  });
}

async function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("landscape");

  pdf.setFont("helvetica", "normal");
  pdf.setFontSize(16);
  pdf.text("ジャンル別集計レポート", 10, 15);

  const genre = selectedPath[selectedPath.length - 1] || "ジャンル未選択";
  const start = document.getElementById("startMonth").value;
  const end = document.getElementById("endMonth").value;
  const fileName = `${genre}_${start}_${end}.pdf`;

  const table = document.querySelector("#dataTable");
  const barCanvas = document.getElementById("barChart");
  const pieCanvas = document.getElementById("pieChart");

  await html2canvas(table).then(canvas => {
    const img = canvas.toDataURL("image/png");
    pdf.addImage(img, 'PNG', 10, 20, 270, 60);
  });

  pdf.addPage();
  await html2canvas(barCanvas).then(canvas => {
    const img = canvas.toDataURL("image/png");
    pdf.addImage(img, 'PNG', 10, 20, 270, 120);
  });

  pdf.addPage();
  await html2canvas(pieCanvas).then(canvas => {
    const img = canvas.toDataURL("image/png");
    pdf.addImage(img, 'PNG', 10, 20, 270, 120);
  });

  pdf.save(fileName);
}

document.addEventListener("DOMContentLoaded", () => {
  const start = document.getElementById("startMonth");
  const end = document.getElementById("endMonth");
  for (let y = 2022; y <= 2025; y++) {
    for (let m = 1; m <= 12; m++) {
      const ym = `${y}-${("0" + m).slice(-2)}`;
      if (ym >= "2022-05" && ym <= "2025-12") {
        start.innerHTML += `<option value="${ym}">${ym}</option>`;
        end.innerHTML += `<option value="${ym}">${ym}</option>`;
      }
    }
  }
  start.value = "2025-04";
  end.value = "2025-05";
});
</script>
</body>
</html>
