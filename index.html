<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ジャンル別CSVビューア（全ジャンル一括ファイル対応）</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .chart-container canvas { width: 100% !important; height: auto !important; margin-top: 40px; }
    #genreSelects select { margin-right: 10px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>ジャンル別CSVビューア</h2>
  <p>ジャンル階層を選んで、該当ジャンルとその下位ジャンルのデータを表示します。</p>

  <div id="genreSelects"></div>
  <label>月: 
    <select id="month">
      <option value="202505">2025年5月</option>
    </select>
  </label>
  <button onclick="loadCSV()">表示</button>

  <div id="tableArea"></div>
  <div class="chart-container">
    <canvas id="barChart"></canvas>
    <canvas id="pieChart"></canvas>
  </div>

  <script>
    let genreTree = {};
    let selectedPath = [];

    fetch('genre_tree.json')
      .then(res => res.json())
      .then(data => {
        genreTree = data;
        renderSelectUI(genreTree, document.getElementById("genreSelects"));
      });

    function renderSelectUI(tree, container, path = []) {
      const select = document.createElement("select");
      select.innerHTML = `<option value="">選択してください</option>`;
      for (const key in tree) {
        const option = document.createElement("option");
        option.value = key;
        option.textContent = key;
        select.appendChild(option);
      }

      select.onchange = () => {
        while (container.children.length > path.length + 1) {
          container.removeChild(container.lastChild);
        }

        const selected = select.value;
        selectedPath = [...path, selected];

        if (selected && tree[selected]) {
          renderSelectUI(tree[selected], container, [...selectedPath]);
        }
      };

      container.appendChild(select);
    }

    function loadCSV() {
      const month = document.getElementById("month").value;
      const fullPath = selectedPath.join('>');
      const filename = `data/all_genres_${month}.csv`;

      fetch(filename)
        .then(response => {
          if (!response.ok) throw new Error("CSVファイルが見つかりません");
          return response.text();
        })
        .then(text => {
          const rows = text.trim().split("\n").map(row => row.split(/,|\t/));
          const headers = rows[0];
          const matched = rows.slice(1).filter(row => row[0].startsWith(fullPath));
          const filtered = [headers, ...matched];
          displayTable(filtered);
          drawCharts(filtered);
        })
        .catch(err => {
          document.getElementById("tableArea").innerHTML = `<p style='color:red;'>${err.message}</p>`;
        });
    }

    function displayTable(rows) {
      let html = "<table id='dataTable'><thead><tr>";
      rows[0].forEach(col => html += `<th>${col}</th>`);
      html += "</tr></thead><tbody>";
      for (let i = 1; i < rows.length; i++) {
        html += "<tr>";
        rows[i].forEach(col => html += `<td>${col}</td>`);
        html += "</tr>";
      }
      html += "</tbody></table>";
      document.getElementById("tableArea").innerHTML = html;
      $("#dataTable").DataTable();
    }

    function drawCharts(rows) {
      const labels = [];
      const values = [];
      for (let i = 1; i < rows.length; i++) {
        labels.push(rows[i][0]);
        values.push(Number(rows[i][1].replace(/,/g, "")));
      }

      if (window.barChart instanceof Chart) {
        window.barChart.destroy();
      }
      window.barChart = new Chart(document.getElementById("barChart"), {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{ label: "実売上（円）", data: values }]
        },
        options: {
          responsive: true,
          plugins: { title: { display: true, text: "ジャンル別 売上（棒グラフ）" } }
        }
      });

      if (window.pieChart instanceof Chart) {
        window.pieChart.destroy();
      }
      window.pieChart = new Chart(document.getElementById("pieChart"), {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{ label: "構成比", data: values }]
        },
        options: {
          responsive: true,
          plugins: { title: { display: true, text: "ジャンル別 売上構成比（円）" } }
        }
      });
    }
  </script>
</body>
</html>
