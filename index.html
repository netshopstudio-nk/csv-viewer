<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ジャンル別 月間合計ビューア</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1 { font-size: 24px; margin-bottom: 20px; }
    select, input[type="month"] { margin: 0 5px 10px 0; }
    canvas { max-width: 800px; margin-top: 40px; }
  </style>
</head>
<body>
  <h1>ジャンル別 月間合計ビューア</h1>

  <div>
    ジャンル階層:
    <select id="genre1"></select>
    <select id="genre2"></select>
    <select id="genre3"></select>
    <select id="genre4"></select>
    <br />
    開始月: <input type="month" id="startMonth">
    終了月: <input type="month" id="endMonth">
    <button id="loadBtn">表示</button>
  </div>

  <table id="resultTable" class="display">
    <thead>
      <tr>
        <th>ジャンル名</th>
        <th>売上指数（千円）</th>
        <th>シェア</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <canvas id="barChart"></canvas>
  <canvas id="pieChart"></canvas>

  <script>
    const csvFolder = 'data';

    const loadCSV = async (filepath) => {
      const response = await fetch(filepath);
      const text = await response.text();
      return text;
    };

    const parseCSV = (csvText) => {
      const lines = csvText.trim().split('\n');
      const headers = lines[0].split(',');
      return lines.slice(1).map(line => {
        const values = line.split(',');
        const entry = {};
        headers.forEach((h, i) => {
          entry[h.trim()] = values[i] ? values[i].trim() : '';
        });
        return entry;
      });
    };

    const formatShare = (value) => (value * 100).toFixed(2) + '%';

    const updateTableAndCharts = (data) => {
      const tbody = $('#resultTable tbody');
      tbody.empty();

      const filteredData = data.filter(row => row['売上指数（千円）'] && !isNaN(row['売上指数（千円）']));
      const totalSales = filteredData.reduce((sum, row) => sum + Number(row['売上指数（千円）']), 0);

      const chartLabels = [];
      const chartData = [];

      filteredData.forEach(row => {
        const sales = Number(row['売上指数（千円）']);
        const share = sales / totalSales;
        chartLabels.push(row['ジャンル名']);
        chartData.push(sales);
        tbody.append(`
          <tr>
            <td>${row['ジャンル名']}</td>
            <td>${sales.toLocaleString()}</td>
            <td>${formatShare(share)}</td>
          </tr>
        `);
      });

      if ($.fn.DataTable.isDataTable('#resultTable')) {
        $('#resultTable').DataTable().destroy();
      }
      $('#resultTable').DataTable();

      const ctxBar = document.getElementById('barChart').getContext('2d');
      const ctxPie = document.getElementById('pieChart').getContext('2d');

      if (window.bar) window.bar.destroy();
      if (window.pie) window.pie.destroy();

      window.bar = new Chart(ctxBar, {
        type: 'bar',
        data: {
          labels: chartLabels,
          datasets: [{ label: '売上指数（千円）', data: chartData, backgroundColor: 'rgba(75, 192, 192, 0.6)' }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false }, title: { display: true, text: '売上指数 棒グラフ' } }
        }
      });

      window.pie = new Chart(ctxPie, {
        type: 'pie',
        data: {
          labels: chartLabels,
          datasets: [{ data: chartData, backgroundColor: chartLabels.map((_, i) => `hsl(${i * 40}, 70%, 70%)`) }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'right' }, title: { display: true, text: '売上シェア 円グラフ' } }
        }
      });
    };

    $('#loadBtn').on('click', async () => {
      const start = document.getElementById('startMonth').value.replace('-', '');
      const end = document.getElementById('endMonth').value.replace('-', '');

      if (!start || !end) return;

      const files = await fetch(csvFolder).then(res => res.text());
      const fileList = Array.from(files.matchAll(/href="(.*?\.csv)"/g)).map(m => m[1]);
      const filtered = fileList.filter(f => {
        const match = f.match(/_(\d{6})\.csv/);
        if (!match) return false;
        const yyyymm = match[1];
        return yyyymm >= start && yyyymm <= end;
      });

      const allData = [];
      for (const file of filtered) {
        const text = await loadCSV(`${csvFolder}/${file}`);
        const rows = parseCSV(text);
        allData.push(...rows);
      }

      updateTableAndCharts(allData);
    });

    // ジャンル選択肢（仮）
    ['genre1','genre2','genre3','genre4'].forEach(id => {
      const sel = document.getElementById(id);
      ['選択してください','食品','健康','飲料','サプリ'].forEach(opt => {
        const o = document.createElement('option');
        o.value = o.text = opt;
        sel.appendChild(o);
      });
    });
  </script>
</body>
</html>
